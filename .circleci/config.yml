version: 2.1

jobs:
  build:
    docker:
      - image: ghcr.io/cirruslabs/flutter:3.29.3
    working_directory: ~/app
    steps:
      - checkout
        
      

      
  
      - run:
          name: Install dependencies
          command: flutter pub get

      - run:
          name: Decode Keystore
          command: echo $KEYSTORE_BASE64 | base64 --decode > android/app/my-release-key.jks

      - run:
          name: Create key.properties
          command: |
            echo "storeFile=android/app/my-release-key.jks" > android/key.properties
            echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
            echo "keyAlias=$KEY_ALIAS" >> android/key.properties
            echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
            

      - run:
          name: Build Signed APK
          command: flutter build apk --release

      - run:
          name: Build Signed AAB
          command: flutter build appbundle --release

      - store_artifacts:
          path: build/app/outputs/flutter-apk/app-release.apk
          destination: app-release.apk

      - store_artifacts:
          path: build/app/outputs/bundle/release/app-release.aab
          destination: app-release.aab

      - run:
          name: Install jq for JSON parsing
          command: |
            apt-get update && apt-get install -y jq

      - run:
          name: Upload APK & AAB to Cloudinary
          command: |
            # Upload APK
            RESPONSE_APK=$(curl -s -X POST https://api.cloudinary.com/v1_1/<your-cloud-name>/raw/upload \
              -F file=@build/app/outputs/flutter-apk/app-release.apk \
              -F upload_preset=unsigned_upload)

            APK_URL=$(echo $RESPONSE_APK | jq -r '.secure_url')
            echo "APK URL: $APK_URL"

            # Upload AAB
            RESPONSE_AAB=$(curl -s -X POST https://api.cloudinary.com/v1_1/<your-cloud-name>/raw/upload \
              -F file=@build/app/outputs/bundle/release/app-release.aab \
              -F upload_preset=unsigned_upload)

            AAB_URL=$(echo $RESPONSE_AAB | jq -r '.secure_url')
            echo "AAB URL: $AAB_URL"

            # Optional: Notify server
            # curl -X POST https://yourserver.com/api/build-complete \
            #  -H "Content-Type: application/json" \
            #  -d "{\"apk_url\":\"$APK_URL\", \"aab_url\":\"$AAB_URL\", \"build_id\":\"$CIRCLE_WORKFLOW_ID\"}"

workflows:
  build_and_upload:
    jobs:
      - build
